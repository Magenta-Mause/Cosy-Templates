{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://github.com/Magenta-Mause/Cosy-Templates/schema/template.schema.json",
  "title": "Game Server Template",
  "description": "Schema for game server deployment templates usable in cosy",
  "$defs": {
    "Variable": {
      "type": "object",
      "required": ["name", "type", "placeholder"],
      "additionalProperties": false,
      "properties": {
        "name": {
          "type": "string",
          "minLength": 1,
          "description": "Display name for the variable"
        },
        "type": {
          "type": "string",
          "enum": ["string", "number", "boolean", "select"],
          "description": "Data type of the variable"
        },
        "regex": {
          "type": "string",
          "description": "Regex pattern for validation (for string type)"
        },
        "placeholder": {
          "type": "string",
          "pattern": "^[a-z_][a-z0-9_]*$",
          "description": "Template placeholder name (used as {{placeholder}})"
        },
        "default": {
          "type": ["string", "number", "boolean"],
          "description": "Default value for the variable"
        },
        "options": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Available options (required for 'select' type)"
        },
        "example": {
          "type": "string",
          "description": "Example value to display for free text inputs (e.g., '1.21.2' for a version field)"
        }
      }
    },
    "ResourceLimit": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "memory": {
          "type": "string",
          "pattern": "^[0-9]+(\\.[0-9]+)?(MiB|GiB)?$",
          "description": "Memory limit (e.g., '128MiB', '1GiB', '512MiB')"
        },
        "cpu": {
          "type": "number",
          "minimum": 0.01,
          "maximum": 128,
          "description": "CPU limit in cores (e.g., 0.5 = half core, 2 = two cores)"
        }
      },
      "description": "Container resource limits"
    }
  },
  "type": "object",
  "required": [
    "name",
    "description",
    "game_id",
    "docker_image_name",
    "docker_image_tag"
  ],
  "additionalProperties": false,
  "properties": {
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "Human-readable name of the server template"
    },
    "description": {
      "type": "string",
      "minLength": 1,
      "maxLength": 500,
      "description": "Brief description of what this template provides"
    },
    "variables": {
      "type": "array",
      "description": "User-configurable variables for the template",
      "items": {
        "$ref": "#/$defs/Variable"
      }
    },
    "game_id": {
      "type": "number",
      "description": "Unique game identifier (SteamGridDB ID or slug)"
    },
    "docker_image_name": {
      "type": "string",
      "pattern": "^[a-z0-9]+([._-][a-z0-9]+)*(/[a-z0-9]+([._-][a-z0-9]+)*)*$",
      "description": "Docker image name (e.g., 'itzg/minecraft-server')"
    },
    "docker_image_tag": {
      "type": "string",
      "minLength": 1,
      "description": "Docker image tag (e.g., 'latest', '1.20.1')"
    },
    "docker_execution_command": {
      "type": ["array", "null"],
      "items": {
        "type": "string"
      },
      "description": "Custom command to execute in the container (e.g. ['npm', 'run', 'dev']). Null for default."
    },
    "environment_variables": {
      "type": "object",
      "additionalProperties": {
        "type": "string"
      },
      "description": "Environment variables passed to the container. Use {{variable}} for template substitution"
    },
    "port_mapping": {
      "type": "object",
      "additionalProperties": {
        "anyOf": [
          {
            "type": "integer",
            "minimum": 1,
            "maximum": 65535
          },
          {
            "type": "string",
            "enum": ["tcp", "udp"]
          }
        ]
      },
      "description": "Port mappings as 'host_port': container_port or 'host_port/protocol': container_port"
    },
    "file_mounts": {
      "type": "array",
      "items": {
        "type": "string",
        "pattern": "^/.*$"
      },
      "description": "Paths inside the container to mount as persistent volumes"
    },
    "resource_limit": {
      "$ref": "#/$defs/ResourceLimit",
      "description": "Optional CPU and memory limits for the container"
    }
  }
}
